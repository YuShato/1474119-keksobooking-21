(()=>{"use strict";window.util={getRandomNumber:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},getRandomProperty:function(e){let t=Object.keys(e);return e[t[t.length*Math.random()<<0]]},setInputAttributes:function(e,t,n){e.required=!0,e.setAttribute("min",t),e.setAttribute("max",n)},setAttributeData:function(e,t,n){e.setAttribute(t,n)}},(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=function(e,t,n,o,r){const u=new XMLHttpRequest;u.responseType="json",u.addEventListener("load",(function(){200===u.status?e(u.response):t("Статус ответа: "+u.status+" "+u.statusText)})),u.addEventListener("error",(function(){t("Произошла ошибка соединения")})),u.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+u.timeout+"мс")})),u.timeout=1e4,u.open(n,o),u.send(r)};window.backend={load:function(e,n){t(e,n,"GET","https://21.javascript.pages.academy/keksobooking/data","")},save:function(e,n,o){t(n,o,"POST",URL,e)},onShowError:function(t){const n=e.cloneNode(!0);n.querySelector(".error__message").textContent=t,n.style="z-index: 100;",document.body.insertAdjacentElement("afterbegin",n);let o=document.querySelector(".error");const r=function(e){"Escape"===e.key&&(e.preventDefault(),document.body.removeChild(o)),document.removeEventListener("keydown",r)};document.addEventListener("keydown",r),o.addEventListener("click",(function(e){"error"!==e.target.className&&"error__button"!==e.target.className||document.body.removeChild(o)})),window.formModule.adForm.addEventListener("submit",(function(){"GET"===window.backend.save.loadType?window.backend.load(window.renderPins,window.util.onShowError):window.backend.save(new FormData(window.formModule.adForm),window.formModule.onFormSendSuccess,window.backend.onShowError)}))},onLoadError:function(){const e=document.createElement("div");let t=document.querySelectorAll(".on-error");const n=function(t){"Escape"===t.key&&(document.body.removeChild(e),document.removeEventListener("keydown",n))};e.className="on-error",e.textContent="Произошла ошибка запроса на сервер. Попробуйте перезагрузить страницу",e.style=" position: absolute;\n      background-color: rgba(255, 86, 53, 0.7);\n      z-index: 100;\n      left: 500px;\n      top: 300px;\n      width: 33%;\n      height: 200px;\n      margin: 0 auto;\n      color: white;\n      font-size: 30px;\n      text-align: center;\n      padding: 25px;\n      tabindex = 0;\n      min-width: 300px;\n      cursor: pointer;",0===t.length&&window.debounce(document.body.appendChild(e)),window.formModule.setDisableInputForm(window.formModule.allFormFilters,window.formModule.allFormLabels,!0,"none"),e.addEventListener("click",(function(){document.body.removeChild(e)})),document.addEventListener("keydown",n)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&clearTimeout(t),t=setTimeout((()=>{e.call(null,...n)}),500)}},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=e.querySelector(".popup__photo"),n=e.querySelector(".popup__photos"),o=e.querySelector(".popup__features"),r=e.querySelector(".popup__title"),u=e.querySelector(".popup__text--address"),i=e.querySelector(".popup__text--price"),l=e.querySelector(".popup__type"),d=e.querySelector(".popup__text--capacity"),c=e.querySelector(".popup__text--time"),a=e.querySelector(".popup__description"),s=e.querySelector(".popup__avatar");window.dataModule={cleanListElement:function(t,n){const o=e.querySelectorAll(n);for(let e=0;e<o.length;e++)t.removeChild(o[e])},fillPhotoSrc:function(e){const o=e.offer.photos;if(window.dataModule.cleanListElement(n,".popup__photo"),o.length>0)for(let e=0;e<o.length;e++){const r=t.cloneNode(!0);window.util.setAttributeData(r,"src",o[e]),n.appendChild(r)}},getCardFeatures:function(e){const t=document.createDocumentFragment();window.dataModule.cleanListElement(o,".popup__feature");for(let n=0;n<e.offer.features.length;n++){let o=document.createElement("li");o.className="popup__feature popup__feature--"+e.offer.features[n],t.appendChild(o)}o.appendChild(t)},fillCardFromServer:function(t){if(r.textContent=t.offer.title,u.textContent=t.offer.address,i.textContent=t.offer.price+"₽/ночь",l.textContent=function(e){let t="";switch(e.offer.type){case"bungalow":t="Бунгало";break;case"flat":t="Квартира";break;case"house":t="Дом";break;case"palace":t="Дворец"}return t}(t),d.textContent=function(e){let t="";switch(e.offer.rooms){case 0:t="это даже не комната ";break;case 1:t="1 комната ";break;case e.offer.rooms>1&&e.offer.rooms>5:t=e.offer.rooms+" комнаты ";break;default:t=e.offer.rooms+" комнат "}return t}(t)+function(e){let t="";switch(e.offer.guests){case 0:t="не для гостей";break;case 1:t="для 1 гостя";break;default:t=`для ${e.offer.guests} гостей`}return t}(t),c.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,a.textContent=t.offer.description,window.dataModule.fillPhotoSrc(t),window.dataModule.getCardFeatures(t),"img/avatars/default.png"!==t.author.avatar)e.appendChild(s),window.util.setAttributeData(s,"src",t.author.avatar);else{const t=e.querySelector(".popup__avatar");t&&e.removeChild(t)}}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.createDocumentFragment(),n=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),r=document.querySelector(".map__filters"),u=document.querySelectorAll("fieldset"),i=document.querySelectorAll(".feature"),l=r.querySelectorAll(".map__filter"),d=r.querySelectorAll(".map__feature"),c=document.querySelector(".map__pin--main"),a=document.querySelector("#address"),s=function(e,t){if(t.length>0)for(let n=0;n<t.length;n++)e.removeChild(t[n])},m=function(){0===document.querySelectorAll(".map__pin:not(.map__pin--main)").length&&(window.backend.load(window.filter.renderCardFromServerData,window.backend.onLoadError),window.pinModule.setPinAdress(c,a)),window.formModule.setDisableInputForm(u,i,!1,"auto"),window.formModule.setDisableInputForm(l,d,!1,"auto")};window.mapModule={showActivePage:m,findButtonSide:function(e){0===e.button&&m()},fragment:t,removeCreatedElements:s,BOOKING_AMOUNT:5,mapPinsButtons:e,deleteAllPins:function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&s(window.mapModule.mapPinsButtons,e)},closeCurrentPopup:function(){let e=document.querySelectorAll(".map__card");e.length>0&&e[0].classList.add("visually-hidden")},addPinFromData:function(n){for(let e=0;e<n.length;e++)t.appendChild(window.pinModule.renderPin(n[e]));window.debounce(e.appendChild(t))},setIdForCard:function(t){const u=function(e){if("map__pin"===e.target.className){let r=Number(e.target.dataset.id);if(r>=0){const e=t.find((e=>e.id===r));window.dataModule.fillCardFromServer(e),o.before(n),window.popupModule.popupClose()}}};r.addEventListener("change",(function(){e.removeEventListener("click",u)})),e.addEventListener("click",u),r.removeEventListener("change",(function(){e.removeEventListener("click",u)}))}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),u=e.querySelector("#housing-features"),i=document.querySelector(".map"),l=e.querySelectorAll(".map__filter"),d=e.querySelectorAll(".map__checkbox"),c=document.querySelector(".ad-form__reset"),a=function(e,t){t.addEventListener("keydown",(function(t){if("Enter"===t.key)for(let n=0;n<e.length;n++)t.target===e[n]&&!1===e[n].checked?e[n].checked=!0:t.target===e[n]&&!0===e[n].checked&&(e[n].checked=!1)}))},s=function(e){return e.filter((function(e){return m(e)&&f(e)&&p(e)&&w(e)&&function(e){const t=u.querySelectorAll(".map__checkbox:checked");if(0===t.length)return!0;let n=!0;return t.forEach((function(t){e.offer.features.includes(t.value)||(n=!1)})),n}(e)})).slice(0,5)},m=function(e){return"any"===t.value||t.value===e.offer.type},f=function(e){return"any"===n.value||"low"===n.value&&e.offer.price<1e4||"middle"===n.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===n.value&&e.offer.price>5e4},p=function(e){return"any"===o.value||+o.value===e.offer.rooms},w=function(e){return"any"===r.value||+r.value===e.offer.guests},y=function(t){window.DATA=t;const n=s(window.DATA);n.forEach((function(e,t){return e.id=t})),window.mapModule.setIdForCard(n),window.debounce(window.mapModule.addPinFromData(n)),i.classList.remove("map--faded"),window.formModule.adForm.classList.remove("ad-form--disabled"),e.removeEventListener("click",y),c.addEventListener("click",window.formModule.resetForm)};e.addEventListener("change",window.debounce((function(){window.mapModule.deleteAllPins(),window.mapModule.closeCurrentPopup(),y(window.DATA)}))),a(d,e),window.filter={applyAll:s,getTypeFilter:m,renderCardFromServerData:y,setFiltersStartValue:function(){for(let e=0;e<l.length;e++)l[e].value="any";for(let e=0;e<d.length;e++)d[e].checked=!1},onKeydownEnterFeatures:a}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pin--main"),n=t.offsetHeight;let o=t.offsetWidth;window.DATA=[];const r=function(e){let t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}};let u=function(e,t){let n=r(e);return t.value=`${Math.floor(n.left+25)}, ${Math.floor(n.top+70)}`,t.value};window.pinModule={renderPin:function(t){const n=e.cloneNode(!0),o=n.querySelector("img");return n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",window.util.setAttributeData(o,"alt",t.offer.title),window.util.setAttributeData(o,"src",t.author.avatar),window.util.setAttributeData(n,"data-id",t.id),n},getCoords:r,setPinAdress:u,setPinStartAdress:function(e,t){let n=r(e);return t.value=`${Math.floor(n.left+12.5)}, ${Math.floor(n.top+35)}`,t.value},activeMapPinMain:function(e){e.addEventListener("keydown",(function(e){"Enter"===e.key&&(window.mapModule.closeCurrentPopup(),window.mapModule.showActivePage())}))},moveMainPin:function(e,r){e.addEventListener("mousedown",(function(e){e.preventDefault();let i={x:e.clientX,y:e.clientY};const l=function(e){e.preventDefault(),function(t){let l=i.x-e.clientX,d=i.y-e.clientY;i={x:e.clientX,y:e.clientY};let c=t.offsetTop-d;c>=130-n-15&&c<=630-n-15&&(t.style.top=c+"px");let a=-1*Math.floor(o/2),s=t.offsetLeft-l;s>=a&&s<=1200+a&&(t.style.left=s+"px"),u(t,r)}(t)},d=function(e){e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",d)}))},returnMainPinPosition:function(){t.style.top="375px",t.style.left="570px",u(t,window.formModule.inputAdress)}}})(),(()=>{const e=document.querySelector("#type"),t=document.querySelector("#title-output"),n=document.querySelector("#adress-output"),o=document.querySelector("#min-price"),r=document.querySelector("#submit-output"),u=document.querySelector("#timein"),i=document.querySelector("#timeout"),l=document.querySelector("#room_number"),d=document.querySelector("#capacity"),c=document.querySelector(".ad-form__submit"),a=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector(".ad-form"),m=s.querySelector("#address"),f=s.querySelector("#title"),p=s.querySelector("#price"),w=s.querySelectorAll("fieldset"),y=s.querySelectorAll(".feature"),v=document.querySelector(".map__filters"),h=v.querySelectorAll(".map__filter"),_=v.querySelectorAll(".map__feature"),S=s.querySelector(".ad-form__reset"),g=document.querySelectorAll(".feature__checkbox");s.action="https://21.javascript.pages.academy/keksobooking",s.method="POST",f.required=!0,m.readOnly=!0,window.util.setInputAttributes(f,30,100),window.util.setInputAttributes(p,0,1e6);const q=function(e,t){let n="";return t.setAttribute("placeholder",e),t.setAttribute("min",e),n="Минимальная цена "+e,o.value=n,n},b=function(e,t,n){setTimeout((function(){c.textContent=t,c.style.color=n}),e)},E=function(e){e.preventDefault(),f.value.length>=f.min&&p.value.length>0?r.textContent="Форма объявления заполнена верно":(r.textContent='Пожалуйста, проверьте введенные данные. Ошибка отправки формы. Исправьте данные и нажмите еще раз на кнопку "Отправить".',b(0,"Ошибка отправки","red"),b(2e3,"Отправить повторно","gold"))},k=function(){i.value=u.value;let e=i.querySelectorAll("option");for(let t=0;t<e.length;t++)e[t].value!==u.value?e[t].setAttribute("disabled",!0):e[t].removeAttribute("disabled",!1)},A=function(){s.reset(),window.mapModule.deleteAllPins(),window.mapModule.closeCurrentPopup(),window.pinModule.returnMainPinPosition(),window.filter.setFiltersStartValue(),function(){const e=s.querySelectorAll("img");for(let t=0;t<e.length;t++)e[t].src="img/muffin-grey.svg"}()},L=function(e){document.body.removeChild(e)},M=function(e,t){e.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),L(t))}))},C=function(e,t,n,o){for(let t=0;t<e.length;t++)e[t].disabled=n;for(let e=0;e<t.length;e++)t[e].style="pointer-events: "+o},F=function(){const e=a.cloneNode(!0);e.style="z-index: 1200;",document.body.insertAdjacentElement("afterbegin",e),A(),document.querySelector(".map").classList.add("map--faded"),s.classList.add("ad-form--disabled"),C(w,y,!0,"none"),c.removeEventListener("click",E),document.addEventListener("click",(function(t){t.target===e&&L(e)})),M(document,e),window.formModule.setDisableInputForm(h,_,!0,"none"),S.removeEventListener("click",P)},x=function(e){e.preventDefault(),c.addEventListener("click",E),c.addEventListener("keydown",(function(e){"Enter"===e.key&&E()})),window.backend.save(new FormData(s),F,window.backend.onShowError)},P=function(e){e.preventDefault(),A()};s.addEventListener("submit",x),S.addEventListener("click",P),S.addEventListener("keydown",(function(e){"Enter"===e.key&&P()})),window.filter.onKeydownEnterFeatures(g,s),window.formModule={checkRoomsAndGuestsCount:function(){const e=function(){let e=d.querySelectorAll("option");for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled",!1),"100"===l.value?d.value=0:d.value=l.value,("0"===e[t].value||l.value<e[t].value&&"100"!==l.value)&&e[t].setAttribute("disabled",!0)};l.addEventListener("change",e),d.addEventListener("change",e)},checkInTime:function(){u.addEventListener("change",k),i.addEventListener("change",k)},setMinPrice:function(){const t=function(){switch(e.value){case"bungalow":q(0,p);break;case"flat":q(1e3,p);break;case"house":q(5e3,p);break;case"palace":q(1e4,p)}};e.addEventListener("change",t),p.addEventListener("input",t)},checkTitleInput:function(){f.addEventListener("input",(function(){let e=f.value.length,n="";e<30?(f.setCustomValidity("Ещё "+(30-e)+" симв."),n="Ещё "+(30-e)+" симв."):e>100?(f.setCustomValidity("Удалите лишние "+(e-100)+" симв."),n="Удалите лишние "+(e-100)+" симв."):(f.setCustomValidity(""),n="Отличный заголовок!",t.style.color="green"),t.value=n}))},inputAdressMessage:function(){m.addEventListener("click",(function(){n.value="Для изменения адреса передвиньте метку на карте"})),m.addEventListener("mouseleave",(function(){n.value=""}))},checkTitleInputInvalid:function(){f.addEventListener("invalid",(function(){f.validity.valueMissing?f.setCustomValidity("Обязательное поле"):f.setCustomValidity("")}))},adForm:s,onFormSendSuccess:F,inputAdress:m,setDisableInputForm:C,hideUserMessageOnEscape:M,onFormSubmit:x,resetForm:P,allFormFilters:h,allFormLabels:_}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n=document.querySelector(".map__pins");window.popupModule={openCardInfo:function(){t.before(e)},closeCardEscButton:function(){n.addEventListener("keydown",(function(e){if("Escape"===e.key){e.preventDefault();const t=document.querySelector(".map__card");t.length>0&&t[0].classList.add("visually-hidden")}}))},popupClose:function(){let e=document.querySelectorAll(".map__card");e.length>0&&(e[0].classList.remove("visually-hidden"),e[0].querySelector(".popup__close").addEventListener("click",(function(){e[0].classList.add("visually-hidden")})))}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),n=window.formModule.adForm.querySelectorAll("fieldset"),o=window.formModule.adForm.querySelectorAll(".feature"),r=document.querySelector(".map__filters"),u=r.querySelectorAll(".map__filter"),i=r.querySelectorAll(".map__feature");e.addEventListener("mousedown",window.mapModule.findButtonSide),window.pinModule.setPinStartAdress(e,t),window.pinModule.moveMainPin(e,t),window.popupModule.closeCardEscButton(),window.formModule.checkTitleInput(),window.formModule.checkTitleInputInvalid(),window.formModule.inputAdressMessage(),window.formModule.setMinPrice(),window.formModule.checkInTime(),window.formModule.checkRoomsAndGuestsCount(),window.formModule.setDisableInputForm(n,o,!0,"none"),window.formModule.setDisableInputForm(u,i,!0,"none"),document.addEventListener("click",(function(t){t.target===e&&(window.mapModule.showActivePage(),window.mapModule.closeCurrentPopup())}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__upload input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),u=function(t,n){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}};t.addEventListener("change",(function(){u(t,n)})),o.addEventListener("click",(function(){0===document.querySelectorAll(".housing-image").length&&function(e){const t=document.createElement("img");t.setAttribute("alt","Фотография жилья"),t.setAttribute("height","100%"),t.setAttribute("width","100%"),t.setAttribute("src","img/muffin-grey.svg"),t.className="housing-image",t.style.borderRadius="5px",e.appendChild(t)}(r)}));const i=function(){const e=r.querySelector("img");u(o,e),o.addEventListener("change",i)};o.addEventListener("change",i)})()})();
(()=>{"use strict";window.util={getRandomNumber:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},getRandomProperty:function(e){let t=Object.keys(e);return e[t[t.length*Math.random()<<0]]},setInputAttributes:function(e,t,n){e.required=!0,e.setAttribute("min",t),e.setAttribute("max",n)},setAttributeData:function(e,t,n){e.setAttribute(t,n)}},(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=function(e,t,n,o,r){const u=new XMLHttpRequest;u.responseType="json",u.addEventListener("load",(function(){200===u.status?e(u.response):t("Статус ответа: "+u.status+" "+u.statusText)})),u.addEventListener("error",(function(){t("Произошла ошибка соединения")})),u.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+u.timeout+"мс")})),u.timeout=1e4,u.open(n,o),u.send(r)};window.backend={load:function(e,n){t(e,n,"GET","https://21.javascript.pages.academy/keksobooking/data","")},save:function(e,n,o){t(n,o,"POST","https://21.javascript.pages.academy/keksobooking",e)},onShowError:function(t){const n=e.cloneNode(!0),o=n.querySelector(".error__button"),r=function(){window.pinModule.returnMainPinPosition(),document.body.removeChild(n),window.formModule.adForm.addEventListener("submit",window.formModule.adForm.onFormSubmit),window.formModule.adForm.addEventListener("submit",u())},u=function(){"GET"===window.backend.save.loadType?window.backend.load(window.renderPins,window.util.onShowError):window.backend.save(new FormData(window.formModule.adForm),window.formModule.onFormSendSuccess,window.backend.onShowError),o.removeEventListener("submit",u)};n.querySelector(".error__message").textContent=t,n.style="z-index: 100;",document.body.insertAdjacentElement("afterbegin",n),o.addEventListener("click",r),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),r())})),o.addEventListener("submit",u),window.formModule.hideUserMessageOnEscape(o,n)}}})(),window.debounce=function(e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout((function(){e.call(null,...n)}),500)}},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=e.querySelector(".popup__photo"),n=e.querySelector(".popup__photos"),o=e.querySelector(".popup__features"),r=e.querySelector(".popup__title"),u=e.querySelector(".popup__text--address"),i=e.querySelector(".popup__text--price"),l=e.querySelector(".popup__type"),d=e.querySelector(".popup__text--capacity"),c=e.querySelector(".popup__text--time"),a=e.querySelector(".popup__description"),s=e.querySelector(".popup__avatar");window.dataModule={cleanListElement:function(t,n){const o=e.querySelectorAll(n);for(let e=0;e<o.length;e++)t.removeChild(o[e])},fillPhotoSrc:function(e){const o=e.offer.photos;if(window.dataModule.cleanListElement(n,".popup__photo"),o.length>0)for(let e=0;e<o.length;e++){const r=t.cloneNode(!0);window.util.setAttributeData(r,"src",o[e]),n.appendChild(r)}},getCardFeatures:function(e){const t=document.createDocumentFragment();window.dataModule.cleanListElement(o,".popup__feature");for(let n=0;n<e.offer.features.length;n++){let o=document.createElement("li");o.className="popup__feature popup__feature--"+e.offer.features[n],t.appendChild(o)}o.appendChild(t)},fillCardFromServer:function(t){r.textContent=t.offer.title,u.textContent=t.offer.address,i.textContent=t.offer.price+"₽/ночь",l.textContent=t.offer.type,d.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,c.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,a.textContent=t.offer.description,window.dataModule.fillPhotoSrc(t),window.dataModule.getCardFeatures(t),"img/avatars/default.png"!==t.author.avatar?(e.appendChild(s),window.util.setAttributeData(s,"src",t.author.avatar)):e.removeChild(s)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.createDocumentFragment(),n=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),r=document.querySelector(".map__filters"),u=document.querySelectorAll("fieldset"),i=document.querySelectorAll(".feature"),l=r.querySelectorAll(".map__filter"),d=r.querySelectorAll(".map__feature"),c=function(e,t){if(t.length>0)for(let n=0;n<t.length;n++)e.removeChild(t[n])},a=function(){0===document.querySelectorAll(".map__pin:not(.map__pin--main)").length&&window.backend.load(window.filter.renderCardFromServerData,window.backend.onShowError),window.formModule.setDisableInputForm(u,i,!1,"auto"),window.formModule.setDisableInputForm(l,d,!1,"auto")};window.mapModule={showActivePage:a,findButtonSide:function(e){0===e.button&&a()},fragment:t,removeCreatedElements:c,BOOKING_AMOUNT:5,mapPinsButtons:e,deleteAllPins:function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&c(window.mapModule.mapPinsButtons,e)},closeCurrentPopup:function(){let e=document.querySelectorAll(".map__card");e.length>0&&e[0].classList.add("visually-hidden")},addPinFromData:function(n){for(let e=0;e<n.length;e++)t.appendChild(window.pinModule.renderPin(n[e]));e.appendChild(t)},setIdForCard:function(t){const u=function(e){if("map__pin"===e.target.className){let r=Number(e.target.dataset.id);if(r>=0){const e=t.find((e=>e.id===r));window.dataModule.fillCardFromServer(e),o.before(n),window.popupModule.popupClose()}}};r.addEventListener("change",(function(){e.removeEventListener("click",u)})),e.addEventListener("click",u),r.removeEventListener("change",(function(){e.removeEventListener("click",u)}))}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),u=e.querySelector("#housing-features"),i=document.querySelector(".map"),l=e.querySelectorAll(".map__filter"),d=e.querySelectorAll(".map__checkbox"),c=document.querySelector(".ad-form__reset"),a=function(e,t){t.addEventListener("keydown",(function(t){if("Enter"===t.key)for(let n=0;n<e.length;n++)t.target===e[n]&&!1===e[n].checked?e[n].checked=!0:t.target===e[n]&&!0===e[n].checked&&(e[n].checked=!1)}))},s=function(e){return e.filter((function(e){return f(e)&&m(e)&&p(e)&&w(e)&&function(e){const t=u.querySelectorAll(".map__checkbox:checked");if(0===t.length)return!0;let n=!0;return t.forEach((function(t){e.offer.features.includes(t.value)||(n=!1)})),n}(e)})).slice(0,5)},f=function(e){return"any"===t.value||t.value===e.offer.type},m=function(e){return"any"===n.value||"low"===n.value&&e.offer.price<1e4||"middle"===n.value&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===n.value&&e.offer.price>5e4},p=function(e){return"any"===o.value||+o.value===e.offer.rooms},w=function(e){return"any"===r.value||+r.value===e.offer.guests},y=function(t){window.DATA=t;const n=s(window.DATA);n.forEach((function(e,t){return e.id=t})),window.mapModule.setIdForCard(n),window.mapModule.addPinFromData(n),i.classList.remove("map--faded"),window.formModule.adForm.classList.remove("ad-form--disabled"),e.removeEventListener("click",y),c.addEventListener("click",window.formModule.resetForm)};e.addEventListener("change",(function(){window.mapModule.deleteAllPins(),window.mapModule.closeCurrentPopup(),window.debounce(y(window.DATA))})),a(d,e),window.filter={applyAll:s,getTypeFilter:f,renderCardFromServerData:y,setFiltersStartValue:function(){for(let e=0;e<l.length;e++)l[e].value="any";for(let e=0;e<d.length;e++)d[e].checked=!1},onKeydownEnterFeatures:a}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pin--main"),n=t.offsetHeight;let o=t.offsetWidth;window.DATA=[];const r=function(e){let t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}};let u=function(e,t){let n=r(e);return t.value=`${Math.floor(n.left+25)}, ${Math.floor(n.top+70)}`,t.value};window.pinModule={renderPin:function(t){const n=e.cloneNode(!0),o=n.querySelector("img");return n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",window.util.setAttributeData(o,"alt",t.offer.title),window.util.setAttributeData(o,"src",t.author.avatar),window.util.setAttributeData(n,"data-id",t.id),n},getCoords:r,setPinAdress:u,activeMapPinMain:function(e){e.addEventListener("keydown",(function(e){"Enter"===e.key&&(window.mapModule.closeCurrentPopup(),window.mapModule.showActivePage())}))},moveMainPin:function(e,r){e.addEventListener("mousedown",(function(e){e.preventDefault();let i={x:e.clientX,y:e.clientY};const l=function(e){e.preventDefault(),function(t){let l=i.x-e.clientX,d=i.y-e.clientY;i={x:e.clientX,y:e.clientY};let c=t.offsetTop-d;c>=130-n-15&&c<=630-n-15&&(t.style.top=c+"px");let a=-1*Math.floor(o/2),s=t.offsetLeft-l;s>=a&&s<=1200+a&&(t.style.left=s+"px"),u(t,r)}(t)},d=function(e){e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",d)}))},returnMainPinPosition:function(){t.style.top="375px",t.style.left="570px",u(t,window.formModule.inputAdress)}}})(),(()=>{const e=document.querySelector("#type"),t=document.querySelector("#title-output"),n=document.querySelector("#adress-output"),o=document.querySelector("#min-price"),r=document.querySelector("#submit-output"),u=document.querySelector("#timein"),i=document.querySelector("#timeout"),l=document.querySelector("#room_number"),d=document.querySelector("#capacity"),c=document.querySelector(".ad-form__submit"),a=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector(".ad-form"),f=s.querySelector("#address"),m=s.querySelector("#title"),p=s.querySelector("#price"),w=s.querySelectorAll("fieldset"),y=s.querySelectorAll(".feature"),v=document.querySelector(".map__filters"),h=v.querySelectorAll(".map__filter"),S=v.querySelectorAll(".map__feature"),_=s.querySelector(".ad-form__reset"),q=document.querySelectorAll(".feature__checkbox");s.action="https://21.javascript.pages.academy/keksobooking",s.method="POST",m.required=!0,f.readOnly=!0,window.util.setInputAttributes(m,30,100),window.util.setInputAttributes(p,0,1e6);const g=function(e,t){let n="";return t.setAttribute("placeholder",e),t.setAttribute("min",e),n="Минимальная цена "+e,o.value=n,n},E=function(e,t,n){setTimeout((function(){c.textContent=t,c.style.color=n}),e)},b=function(e){e.preventDefault(),m.value.length>=m.min&&p.value.length>0?r.textContent="Форма объявления заполнена верно":(r.textContent='Пожалуйста, проверьте введенные данные. Ошибка отправки формы. Исправьте данные и нажмите еще раз на кнопку "Отправить".',E(0,"Ошибка отправки","red"),E(2e3,"Отправить повторно","gold"))},M=function(){s.reset(),window.mapModule.deleteAllPins(),window.mapModule.closeCurrentPopup(),window.pinModule.returnMainPinPosition(),window.filter.setFiltersStartValue()},k=function(e){s.removeChild(e)},A=function(e,t){e.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),k(t))}))},L=function(e,t,n,o){for(let t=0;t<e.length;t++)e[t].disabled=n;for(let e=0;e<t.length;e++)t[e].style="pointer-events: "+o},C=function(){const e=a.cloneNode(!0);e.style="z-index: 1200;",s.insertAdjacentElement("afterbegin",e),M(),document.querySelector(".map").classList.add("map--faded"),s.classList.add("ad-form--disabled"),L(w,y,!0,"none"),c.removeEventListener("click",b),document.addEventListener("click",(function(t){t.target===e&&k(e)})),A(document,e),window.formModule.setDisableInputForm(h,S,!0,"none"),_.removeEventListener("click",P)},F=function(e){e.preventDefault(),c.addEventListener("click",b),c.addEventListener("keydown",(function(e){"Escape"===e.key&&b()})),window.backend.save(new FormData(s),C,window.backend.onShowError)},P=function(e){e.preventDefault(),M()};s.addEventListener("submit",F),_.addEventListener("click",P),_.addEventListener("keydown",(function(e){"Enter"===e.key&&P()})),window.filter.onKeydownEnterFeatures(q,s),window.formModule={checkRoomsAndGuestsCount:function(){l.addEventListener("change",(function(){let e=d.querySelectorAll("option");for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled",!1),"100"===l.value?d.value=0:d.value=l.value,("0"===e[t].value||l.value<e[t].value&&"100"!==l.value)&&e[t].setAttribute("disabled",!0)}))},checkInTime:function(){u.addEventListener("change",(function(){i.value=u.value;let e=i.querySelectorAll("option");for(let t=0;t<e.length;t++)e[t].value!==u.value?e[t].setAttribute("disabled",!0):e[t].removeAttribute("disabled",!1)}))},setMinPrice:function(){const t=function(){switch(e.value){case"bungalow":g(0,p);break;case"flat":g(1e3,p);break;case"house":g(5e3,p);break;case"palace":g(1e4,p)}};e.addEventListener("change",t),p.addEventListener("input",t)},checkTitleInput:function(){m.addEventListener("input",(function(){let e=m.value.length,n="";e<30?(m.setCustomValidity("Ещё "+(30-e)+" симв."),n="Ещё "+(30-e)+" симв."):e>100?(m.setCustomValidity("Удалите лишние "+(e-100)+" симв."),n="Удалите лишние "+(e-100)+" симв."):(m.setCustomValidity(""),n="Отличный заголовок!",t.style.color="green"),t.value=n}))},inputAdressMessage:function(){f.addEventListener("click",(function(){n.value="Для изменения адреса передвиньте метку на карте"})),f.addEventListener("mouseleave",(function(){n.value=""}))},checkTitleInputInvalid:function(){m.addEventListener("invalid",(function(){m.validity.valueMissing?m.setCustomValidity("Обязательное поле"):m.setCustomValidity("")}))},adForm:s,onFormSendSuccess:C,inputAdress:f,setDisableInputForm:L,hideUserMessageOnEscape:A,onFormSubmit:F,resetForm:P}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n=document.querySelector(".map__pins");window.popupModule={openCardInfo:function(){t.before(e)},closeCardEscButton:function(){n.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),document.querySelector(".map__card").classList.add("visually-hidden"))}))},popupClose:function(){let e=document.querySelectorAll(".map__card");e.length>0&&(e[0].classList.remove("visually-hidden"),e[0].querySelector(".popup__close").addEventListener("click",(function(){e[0].classList.add("visually-hidden")})))}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),n=window.formModule.adForm.querySelectorAll("fieldset"),o=window.formModule.adForm.querySelectorAll(".feature");e.addEventListener("mousedown",window.mapModule.findButtonSide),window.pinModule.setPinAdress(e,t),window.pinModule.moveMainPin(e,t),window.popupModule.closeCardEscButton(),window.formModule.checkTitleInput(),window.formModule.checkTitleInputInvalid(),window.formModule.inputAdressMessage(),window.formModule.setMinPrice(),window.formModule.checkInTime(),window.formModule.checkRoomsAndGuestsCount(),window.formModule.setDisableInputForm(n,o,!0,"none"),document.addEventListener("click",(function(t){t.target===e&&(window.mapModule.showActivePage(),window.mapModule.closeCurrentPopup())}))})()})();